<%= form_for(character.skill_set, method: 'PUT', url: dg_character_skill_set_path(character, character.skill_set)) do |f| %>
  <div class="top-bar">
    <div class="top-bar-left">
      <ul class="breadcrumbs">
        <li><%= link_to('Home', user_path(current_user)) %></li>
        <li><%= link_to(character.campaign.name, character.campaign) %></li>
        <li><%= link_to(character.display_name, character) %></li>
        <li>Set Statistics</li>
      </ul>
    </div>
  </div>

  <div class="grid-x align-center">
    <div class="cell small-12">
      <fieldset class="fieldset">
        <div class="callout secondary">
          First, choose your occupation. This should align with your "profession" (chosen previously). Each occupation has a set of skills associated with it.  Some professions also provide optional skills.
        </div>
        <legend>Choose Occupation</legend>
        <div class="grid-x grid-margin-x align-center">
          <div class="cell small-12 medium-4">
            <%= f.select :occupation, options_for_select([['---Choose Occupation---', '']]) %>
          </div>
          <%= f.hidden_field :bonds %>
          <div class="cell small-12 medium-4"> </div>
          <div class="cell small-12 medium-4"> </div>
          <div class="cell small-12 medium-4">
            <table id="info-occupational-skills-table">
              <tr><td><strong>Description: </strong></span></td></tr>
              <tr><td><strong>Reccomended Stats: </strong></span></td></tr>
              <tr><td><strong>Bonds: </strong></td></tr>
            </table>
          </div>
          <div class="cell small-12 medium-4">
            <table id="occupational-skills-table">
              <tr><td><strong>Included Occupation Skills: </strong></td></tr>
            </table>
          </div>
          <div class="cell small-12 medium-4">
            <table id="optional-occupational-skills-table">
              <tr><td><strong>Optional Occupation Skills: </strong></td></tr>
            </table>
          </div>
        </div>
      </fieldset>
    </div>
  </div>
  <div class="grid-x grid-margin-x align-center">
    <div class="cell small-12">
      <fieldset class="fieldset">
        <legend>Choose Skill Package</legend>
        <div class="callout secondary">
          Then, choose your bonus skill package. These are additional skills that are not necessarily associated with your occupation. These skills might have come from a prior career or personal hobby.
        </div>
        <div class="grid-x grid-margin-x align-center">
          <div class="cell small-12 medium-4">
            <%= f.select :bonus_skill_package, options_for_select([['---Choose Skill Package---', '']]) %>
          </div>
          <div class="cell small-12 medium-4">
            <table id="skill-packages-table">
              <tr><td><strong>Package Skills: </strong></span></td></tr>
            </table>
          </div>
          <div class="cell small-12 medium-4"></div>
        </div>
      </fieldset>
    </div>
  </div>
  <%= render 'skill_set_table', f: f, character: character, skill_set: skill_set %>
  <div>
    <%= f.submit "Save", class: 'button' %>
  </div>
  <script type="text/javascript">
$(window).load(function() {

  const occupationSkill = new Dg.OccupationSkill()

  _.each(Dg.OccupationSkills, (occ, id) => {
    const option = $(`<option value="${id}">${occ.name}</option>`)
    $('#dg_skill_set_occupation').append(option)
  })


  _.each(Dg.SkillPackages, (pack, name) => {
    const option = $(`<option value="${name}">${name}</option>`)
    $('#dg_skill_set_bonus_skill_package').append(option)
  })

  _selectOption = (skill) => {
    return (event) => {
      occupationSkill.selectOption(skill)
      _reset()
    }
  }

  _renderOccupationSkill = (skill, option, selected) => {
    const tr = $('<tr></tr>')
    const td = $('<td></td>')
    const div = $('<div class="clearfix"></div>')
    const leftDiv = $('<div class="float-left"></div>')
    const rightDiv = $('<div class="float-right"></div>')
    leftDiv.append(skill.skill)
    if(skill.type) {
      leftDiv.append(` (${skill.type})`)
    }
    leftDiv.append(` + ${skill.percentage}%`)
    div.append(leftDiv)
    if(option) {
      rightDiv.append(`<input class="switch-input" id="option-${skill.id}" type="checkbox" name="exampleSwitch"><label class="switch-paddle" for="option-${skill.id}"><span class="show-for-sr"></span></label>`)
      div.append(rightDiv)
    }

    td.append(div)

    tr.append(td)
    $(`#${option ? 'optional-' : ''}occupational-skills-table`).append(tr)
    $(`#option-${skill.id}`).change(_selectOption(skill.id))
    if(selected) {
      $(`#option-${skill.id}`).prop('checked', true)
    }
  }

  _renderSkillPackageSkill = (packageOptions, packageSkill) => {
    if(packageSkill.id.match(/\d/)) {
      const count = Number(packageSkill.id)
      _.times(count, (i) => {
        const tr = $('<tr></tr>')
        const td = $('<td></td>')
        tr.append(td)
        const select = $('<select class="skill-package-option"><option value="">--Choose Skill--</option></select>')
        _.each(_.keys(Dg.BaseSkillValues), (skillKey) => {
          let name = skillKey.replace(/_/g, ' ')
          name = name.charAt(0).toUpperCase() + name.substr(1);
          select.append($(`<option value="${skillKey}">${name}</option>`))
        })
        select.val(packageOptions[i])
        select.change((event) => {
          occupationSkill.selectPackageOption(i, event.target.value)
          _reset()
        })
        td.append(select)
        td.append(' + 20%')
        $('#skill-packages-table').append(tr)
      })
    } else {
      const tr = $('<tr></tr>')
      const td = $('<td></td>')
      tr.append(td)
      td.append(`${packageSkill.skill} + 20%`)
      $('#skill-packages-table').append(tr)
    }
  }

  const _reset = () => {
    const value = occupationSkill.getValues()
    $('#info-occupational-skills-table').html('')
    $('#occupational-skills-table').html('')
    $('#optional-occupational-skills-table').html('')

    //description
    $('#info-occupational-skills-table').append($(`<tr><td><strong>Description: </strong>${value.occupation.description || ''}</td></tr>`))

    //recomended stats
    $('#info-occupational-skills-table').append($(`<tr><td><strong>Reccomended Stats: </strong>${value.occupation.recommended_stats || ''}</td></tr>`))

    //bonds
    $('#info-occupational-skills-table').append($(`<tr><td><strong>Bonds: </strong>${value.occupation.bonds || ''}</td></tr>`))
    $('#dg_skill_set_bonds').val(value.occupation.bonds)

    //occupation skills
    $('#occupational-skills-table').append($(`<tr><td><strong>Included Occupation Skills: </strong></td></tr>`))
    _.each(value.occupation.skills, (skill, id) => {
      _renderOccupationSkill(skill, false)
    })

    //optional skills
    const optionsTr = $('<tr></tr>')
    const optionsTd = $('<td></td>')
    optionsTd.append($('<strong>Optional Occupation Skills: </strong>'))
    if(value.occupation.choose) {
      optionsTd.append(`Choose ${value.occupation.choose}`)
    }
    optionsTr.append(optionsTd)
    $('#optional-occupational-skills-table').append(optionsTr)

    _.each(value.occupation.options, (option) => {
      const selected = _.contains(value.chosenOptions, option.id)
      _renderOccupationSkill(option, true, selected)
    })

    //bonus skill set
    $('#skill-packages-table').html('')
    $('#skill-packages-table').append('<tr><td><strong>Package Skills:</strong></td></tr>')
    _.each(value.skillPackage, (packageSkill) => {
      _renderSkillPackageSkill(value.packageOptions, packageSkill)
    })

    //reset table
    _.each(value.skills, (skill, id) => {
      const underscoreId = id.replace('-', '_')
      const percentage = Math.min(_.reduce(skill.additions, (perc, addition) => perc + addition, skill.value), 80)
      $(`#${id}-additions`).html('')
      _.each(skill.additions, (addition) => {
        $(`#${id}-additions`).append(` + ${addition}%`)
      })
      $(`#dg_skill_set_${underscoreId}`).val(percentage)
      $(`#${underscoreId}`).html(`${percentage}%`)

      if(id.match(/_\d/)) {
        if(percentage > 0) {
          if(skill.type) {
            $(`#dg_skill_set_${underscoreId}_text`).val(skill.type)
          } else {
            $(`#dg_skill_set_${underscoreId}_text`).val('')
          }
        } else {
          $(`#dg_skill_set_${underscoreId}_text`).val('')
        }
      }
    })
  }

  $('#dg_skill_set_occupation').change( (event) => {
    occupationSkill.setOccupation(event.target.value)
    _reset()
  })

  $('#dg_skill_set_bonus_skill_package').change( (event) => {
    occupationSkill.setSkillPackage(event.target.value)
    _reset()
  })

  $('#dg_skill_set_occupation').val('<%= skill_set.occupation%>')
  occupationSkill.setOccupation('<%= skill_set.occupation%>')
  $('#dg_skill_set_bonus_skill_package').val('<%= skill_set.bonus_skill_package%>')
  occupationSkill.setSkillPackage('<%= skill_set.bonus_skill_package%>')
  _reset()
})
  </script>
<% end %>
